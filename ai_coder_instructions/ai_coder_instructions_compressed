# xlwings Lite : Coding Guidelines for AI Coders (Humans Welcome)

# SYSTEM CONSTRAINTS (MUST FOLLOW)
These are the absolute highest priority rules. You must verify your code against these before outputting.
1. **NO INDEXES:** Always use `.options(index=False)` when writing DataFrames. `sheet.value = df` is FORBIDDEN.
2. **ROBUST SHEET DELETION:** Never assume a sheet doesn't exist. Always check and delete before creating: `if s.name == 'MySheet': s.delete()`.
3. **NO AUTO-FIT:** Never call `.autofit()`. It is not supported.
4. **NO RGB TUPLES:** Always use hex strings (e.g., '#F0F0F0') for colors.

### Last Update date: 30th NOVEMBER 2025

## 1. Introduction
This document provides coding guidelines for xlwings Lite - a browser-based Python environment running inside Excel.

## 2. Execution Context (Where Your Code Runs)
**YOUR CODE RUNS IN:**
- **File:** `main.py` inside the xlwings Lite add-in task pane (right side of Excel)
- **Environment:** Pyodide (Python compiled to WebAssembly, runs in browser sandbox)
- **Trigger:** User clicks play button or presses F5 to execute `@script` decorated functions
- **Access:** Your code has direct read/write access to the active workbook via `book: xw.Book`
- **Output:** `print()` statements appear in the console log below the code editor
- **Dependencies:** Managed via `requirements.txt` tab in the same task pane

## 3. Golden Rules (Non-Negotiable for All Scripts)

### 3.1 Mandatory Helper Function
```python
import xlwings as xw
import pandas as pd
from typing import Tuple, Optional, Any

def find_table_in_workbook(book: xw.Book, table_name: str) -> Tuple[Optional[xw.Sheet], Any]:
    """Returns (sheet, table) or (None, None). MUST use this - table.sheet doesn't exist in Lite."""
    for sheet in book.sheets:
        if table_name in sheet.tables:
            return sheet, sheet.tables[table_name]
    return None, None

# Usage:
sheet, table = find_table_in_workbook(book, 'MyTable')
df = table.range.options(pd.DataFrame, index=False).value  # index=False for READING too!
```

### 3.2 Critical Rules (Will Crash If Ignored)

| # | Rule | Why It Fails in Lite |
|---|------|---------------------|
| 1 | Use `find_table_in_workbook()` helper above | `table.sheet` attribute doesn't exist |
| 2 | Use `.options(index=False)` for DataFrames | Default includes index column |
| 3 | Use hex colors `'#RRGGBB'`, never RGB tuples | RGB tuples raise `ValueError` |
| 5 | Use `.resize(rows, cols)` not `.expand()` | `.expand()` runs before Excel registers data â†’ `IndexError` |
| 6 | Wrap `tables.add()` in `try...except` | Can fail silently |
| 11 | Write non-DataFrame data cell-by-cell | 2D list writes cause silent `InvalidArgument` |
| 14 | Use `None` not `''` for missing numbers | Mixed types cause `InvalidArgument` |
| 15 | Never use `sheet.autofit()` | Not supported â†’ `NotImplementedError` |
| 17 | Omit table names in loops/multi-table | Named tables in succession crash |
| 21 | Delete existing sheet before `sheets.add()` | Re-running fails otherwise |

### 3.3 Data Type Rules (Prevent Silent InvalidArgument Errors)
```python
# WRONG: Mixed types in column
df['Value'] = ['<600', 600, 700]  # InvalidArgument when writing

# CORRECT: Convert to string
df['Value'] = df['Value'].astype(str)

# WRONG: Empty string for missing numeric
df['P-Value'] = [0.05, '', 0.03]  # InvalidArgument

# CORRECT: Use None
df['P-Value'] = [0.05, None, 0.03]  # Writes as blank cell
```

### 3.4 Summary Table Patterns
**Simple aggregation (safe):**
```python
summary_df = df.groupby('Category').agg(Count=('ID', 'count')).reset_index()
```

**Pivoted/reshaped summaries (use list-of-dicts):**
```python
# WRONG: .unstack() fails if group missing
# df.groupby(['GROUP', 'Var']).agg(...).unstack()

# CORRECT: Build row-by-row
report_rows = []
for var in numeric_vars:
    report_rows.append({
        'Variable': var,
        'Test': df[df['GROUP']=='TEST'][var].mean(),
        'Control': df[df['GROUP']=='CONTROL'][var].mean()
    })
final_df = pd.DataFrame(report_rows)
```

### 3.5 Other Important Rules
- **#4:** Custom functions (`@func`) must use `typing.Any` for cell inputs, not specific types
- **#8/13:** Mixed-type columns in summary tables cause silent `GeneralException`
- **#9:** Use list-of-dicts pattern for pivoted summaries (see 3.4)
- **#10:** All user-executable functions need `@script` decorator
- **#12:** Persistent errors after "it was working" â†’ ask user if they renamed output sheet
- **#16:** Use `train_test_split(stratify=...)` for balanced sampling
- **#18:** Call `sheet.activate()` on final output sheet
- **#19:** Don't chain `pd.to_numeric().fillna(median())` - convert first, then calculate median
- **#20:** Separate calculation logic from Excel I/O for debuggability

### 3.6 Robustly Creating Quantile Bins
```python
df['tertile'] = pd.qcut(df['SCORE'], 3, labels=False, duplicates='drop')  # duplicates='drop' prevents crash
```

### 3.7 Known Limitations
> - **Font Properties:** Font properties (`bold`, `italic`, `color`, `size`, `name`) can be **set**, but they cannot be **read**.
>
> - **Custom Script Arguments:** Custom scripts (decorated with `@script`) can only accept a single argument: `book: xw.Book`.
>
> - **No Direct API Access:** The `.api` property is not available.

### 3.8 Robust Data Writing (Summary)
- **DataFrames:** Write directly with `sheet["A1"].options(index=False).value = df` (stable, reliable)
- **Non-DataFrame data:** Write cell-by-cell (2D list writes are unstable in Lite)
- **Separate calculation from I/O:** Complete all pandas operations first, then write to Excel in a final block
- See Section 13.4 for code examples

## 4. Compatibility
Supported: Windows/macOS (Microsoft 365, Office 2021+), Excel on the Web (any modern browser).

## 6. Custom Functions
### 6.1 Basic Syntax
```python
from xlwings import func

@func
def hello(name):
    return f"Hello {name}!"
```
Call in Excel with: `=HELLO("World")` or `=HELLO(A1)`

### 6.2 Working with DataFrames
```python
import pandas as pd
from xlwings import func, arg, ret

@func
@arg("df", pd.DataFrame)
@ret(index=False, header=False)
def correl2(df):
    return df.corr()
```

### 6.3 Type Hints Support
```python
from xlwings import func
import pandas as pd

@func
def myfunction(df: pd.DataFrame) -> pd.DataFrame:
    return df
```

### 6.4 Variable Arguments
```python
from xlwings import func, arg

@func
@arg("*args", pd.DataFrame, index=False)
def concat(*args):
    return pd.concat(args)
```

### 6.5 Documentation
```python
from xlwings import func, arg

@func
@arg("name", doc='A name such as "World"')
def hello(name):
    """This is a classic Hello World example"""
    return f"Hello {name}!"
```

### 6.6 Date/Time Handling
```python
import datetime as dt
from xlwings import func

@func
@arg("date", dt.datetime)
def process_date(date):
    return date

# For multiple dates in a range
import xlwings as xw
@func
def process_dates(dates):
    return [xw.to_datetime(d) for d in dates]

# For DataFrames with dates
@func
@arg("df", pd.DataFrame, parse_dates=[0])
def timeseries_start(df):
    return df.index.min()
```

### 6.7 Robustness and Debugging for Custom Functions

**CRITICAL FOR AI CODERS:** The most common point of failure for custom functions (`@func`) is the `#VALUE!` error. This is almost always caused by a data type mismatch between the Excel cell and the function's argument type hint. This "pre-emptive type conversion" by the xlwings engine occurs *before* your Python code's `try...except` block can catch the error.

#### 6.7.1 The Mandatory Pattern for Robust Custom Functions

To prevent these failures, **all functions that accept arguments from Excel cell references MUST follow this pattern**:

1.  **Use `typing.Any` as the type hint.** This instructs the xlwings engine to pass the value as-is, without attempting a risky pre-conversion.
2.  **Perform data type conversions safely *inside* the function** using a robust helper function.

**Incorrect (Brittle) Approach:** Fails if `value` is blank or text.
```python
@func
def my_function(value: float):
    # This code is never reached if the pre-conversion fails.
    return value * 2
```

**Correct (Robust) Approach:** Handles any input gracefully.
```python
from typing import Any

def _to_float(value: Any, default_if_error: float) -> float:
    """Safely converts any value (int, str, None) to a float."""
    if value is None:
        return default_if_error
    try:
        return float(value)
    except (ValueError, TypeError):
        return default_if_error

@func
def my_function(value: Any):
    # The conversion is now handled safely inside our code.
    numeric_value = _to_float(value, 0.0)
    return numeric_value * 2
```

#### 6.7.2 Troubleshooting #VALUE! in Custom Functions
Follow this exact debugging sequence:
1. Check for Syntax Errors: First, confirm the function is recognized by Excel's autocomplete. If not, there is likely a syntax error in main.py (e.g., a misplaced import) preventing the file from loading. Test by replacing the entire file with a minimal function.

2. Use the Minimal Debug Function: To diagnose data type issues, use this universal test function. It bypasses all conversion issues and reports exactly what Python receives.

```python
from typing import Any

@func
@arg("CELL_VALUE", doc="A single cell to test.")
def final_debug_test(CELL_VALUE: Any) -> str:
    """Receives any value and reports its type and string representation."""
    try:
        value_type = type(CELL_VALUE).__name__
        str_value = str(CELL_VALUE)
        return f"Success! Type is '{value_type}', Value is '{str_value}'"
    except Exception as e:
        return f"Error: {e}"
```

3. Analyze and Implement: Apply the `=FINAL_DEBUG_TEST(A1)` formula. The output (Success! Type is 'int', ...) will reveal the data types. Refactor the failing function using the mandatory robust pattern from section 6.7.1.

### 6.8 Why Custom Scripts (@script) Avoid This Issue
This data type issue primarily affects custom functions (`@func`) and not scripts (`@script`) due to their fundamentally different data processing models:

| Aspect | Custom Script (@script) | Custom Function (@func) |
|--------|--------------|-------|
| Data Flow | Bulk Operation (entire tables/ranges) | Scalar Operation (one cell per argument) |
| Conversion Engine | pandas DataFrame converter | Direct "Argument Marshalling" Bridge |
| Robustness | High. Pandas is designed to handle messy, mixed-type data and infer column dtypes without crashing. | Low (by default). Prone to failure if a cell's type doesn't match the argument's type hint. |
| Solution | Use pd.to_numeric after loading data into a DataFrame. | Use the typing.Any pattern to handle conversion manually. |

## 7. Custom Scripts
### 7.1 Basic Syntax
Custom Scripts in xlwings Lite are Python functions that run at the click of a button and have access to the Excel object model. They are equivalent to VBA Subs or Office Scripts.

```python
import xlwings as xw
from xlwings import script

@script
def hello_world(book: xw.Book):
    sheet = book.sheets[0]
    sheet["A1"].value = "Hello xlwings!"
```

### 7.2 Running Scripts
- Click the run button or press F5 in the xlwings Lite add-in
- Select different scripts from the dropdown menu
- Changes to script names automatically update in the dropdown

### 7.3 Sheet Buttons
- Create buttons using Excel shapes with hyperlinks
- Name the shape in the name box (e.g., `xlwings_button`)
- Link the shape to a cell behind it (e.g., `B4`)
- Configure the script with:
```python
@script(button="[xlwings_button]Sheet1!B4", show_taskpane=True)
def hello_world(book: xw.Book):
    # your code here
```
Note: Button clicks change cell selection, so don't use for scripts that depend on selected cells.

### 7.4 Configuration Options
```python
@script(
    include=["Sheet1", "Sheet2"],  # Only include these sheets' content
    exclude=["BigData"],  # Exclude these sheets' content
    button="[mybutton]Sheet1!A1",  # Sheet button configuration
    show_taskpane=True  # Show taskpane when button clicked
)
```

### 7.5 Tips and Troubleshooting
- Use `include`/`exclude` to limit data transfer for large workbooks
- Only include sheets needed by your script
- Don't select the linked cell initially
- Verify button name in script decorator matches exactly
- Restart xlwings Lite to re-register event handlers
- Excel web doesn't support adding shape hyperlinks (but works if set up in desktop)

### 7.5.1 InvalidArgument Troubleshooting (Diagnose in Order)

**Cause 1: Mixed Data Types** (Most Common)
â†’ See Section 3.3 for examples. Use `None` not `''`, or `.astype(str)` for mixed columns.

**Cause 2: Sheet Renaming Contamination**
Script was working, now fails after user manually renamed an output sheet (e.g., `RESULTS` â†’ `RESULTS_v1`).
- **Fix:** Ask user to delete the renamed sheet and re-run
- **Prevention:** Use "Move or Copy â†’ Create a copy" instead of renaming

**Cause 3: API Instability (Last Resort)**
If Causes 1 & 2 don't apply, force an API sync before `tables.add()` or `.number_format`:
```python
sheet["Z1"].value = "SYNC"  # Force write
_ = sheet["Z1"].value       # Force read roundtrip
sheet.tables.add(source=my_range)  # Now this works
sheet["Z1"].value = ""      # Cleanup
```

## 8. Comprehensive Guide to Limitations & Unsupported Features
This section provides a consolidated overview of all known limitations in xlwings Lite as of June 2025. Understanding these constraints is crucial for effective development.

### 8.1 Pyodide and Environment Constraints
xlwings Lite runs on Pyodide, which imposes several environment-level restrictions:
- **Python Version**: The Python version is fixed by the specific Pyodide distribution used in the add-in.
- **Memory Limit**: There is a 2GB memory limit for the Python environment.
- **Debugging**: There is no debugger support. Use `print()` statements to the Output Pane for debugging.
- **Concurrency**: `multiprocessing` and `threading` are not supported.
- **Package Availability**: Only packages that are pure Python or have been specifically compiled for the Pyodide environment can be used. Check the [official Pyodide packages list](https://pyodide.org/en/stable/usage/packages-in-pyodide.html) for availability.
- **Network Connections**: Direct TCP/IP sockets are not available. This means:
    - No direct connections to databases like PostgreSQL, MySQL, etc. (must use a web API layer).
    - All HTTP requests are subject to browser CORS (Cross-Origin Resource Sharing) policies.

### 8.2 Unsupported xlwings API Features
Most unsupported methods raise `NotImplementedError` when called. However, these **commonly-attempted features** are worth knowing upfront:

| Feature | Status | Workaround |
|---------|--------|------------|
| `table.sheet` | **Fails silently** (no error) | Use `find_table_in_workbook()` helper (Section 3.1) |
| `sheet.autofit()` | `NotImplementedError` | Set `range.column_width` manually or skip |
| `book.save()` | Not supported | Workbook auto-saves; user saves manually |
| `sheet.used_range` | Not supported | Track your data bounds explicitly |
| `sheet.copy()` | Not supported | Create new sheet, copy data manually |
| `charts.add()` | Not supported | Use matplotlib â†’ `pictures.add()` instead |
| `range.api` | Not supported | No direct Excel JS API access |
| `Font` properties | **Can SET, cannot GET** | Don't try to read font properties |

> **General Rule:** If you get `NotImplementedError`, the feature isn't available in Lite. Check the [xlwings Lite docs](https://docs.xlwings.org/en/latest/lite.html) for current status.

### 8.3 Planned Future Enhancements
The following features are on the development roadmap but are **not yet available** as of June 2025.

- **File System Access**:
  - âŒ No local file access
  - âŒ No direct file system operations
  - ðŸ”„ Planned: Enable access to local files

- **Development Features**:
  - âŒ No interactive Python terminal
  - âŒ No multiple Python modules
  - âŒ No external code storage
  - âŒ Limited code completion
  - âŒ No dark mode
  - ðŸ”„ Planned: All these features in development

- **Excel Integration**:
  - âŒ No streaming functions
  - âŒ No object handles
  - âŒ Can't use Excel calculated values in same script
  - âŒ Limited formatting and charting
  - ðŸ”„ Planned: Improved Excel object model coverage

- **Advanced Features**:
  - âŒ No Git integration
  - âŒ No Jupyter/marimo notebook support
  - âŒ No backend server option
  - âŒ Fixed Pyodide version
  - ðŸ”„ Planned: All these features in roadmap

> **Note:** When users request unavailable features, guide them to use available workarounds, consider alternative approaches, and watch for updates in newer versions.

## 9. Connecting to External Data & APIs
This section details how xlwings Lite interacts with external data sources, including web APIs and databases. Due to its browser-based environment (Pyodide), direct database connections are not supported; all interactions must occur via web APIs.

### 9.1 Working with Web APIs
xlwings Lite supports common Python HTTP libraries and Pyodide's native `pyfetch` for making web requests.

1.  **Supported Libraries**:
    *   `requests`: For synchronous HTTP requests.
    *   `httpx`, `aiohttp`: For asynchronous HTTP requests (requires `async/await` syntax).
    *   `pyfetch`: Pyodide's native asynchronous JavaScript fetch wrapper.

    ```python
    # Synchronous with requests
    import requests
    response = requests.get("https://api.example.com/data")
    
    # Async with aiohttp
    import aiohttp
    async with aiohttp.ClientSession() as session:
        async with session.get("https://api.example.com/data") as response:
            data = await response.json()
    ```

2.  **Handling API Responses**:
    *   For FastAPI servers returning file responses, use `await response.text()` to extract content.
    *   Pipe-delimited data (common in FastAPI file responses) can be parsed by splitting lines with `.split("
")` and columns with `.split("|")`.
    *   When working with RexDB server responses, process them as plain text rather than attempting to parse as JSON.

3.  **Best Practices for Web API Requests**:
    *   Always use HTTPS for API requests.
    *   Handle errors gracefully with `try...except` blocks.
    *   Log detailed error information for debugging.
    *   Consider implementing request retries for reliability.

### 9.2 Connecting to Databases via an API Layer
Direct SQL database connections are **not supported** in xlwings Lite (no TCP sockets in browser). All database interactions must go through a web API layer.

**Options:**
- **Custom API:** Build with FastAPI/Flask for full control
- **Ready-to-Use REST APIs:** PostgREST, Supabase (PostgreSQL), Oracle ORDS, MySQL REST Service, NocoDB
- **SQLite:** Can download `.db` file and process locally with `sqlite3` (add to requirements.txt)


## 10. Security Best Practices
Security is paramount when working with xlwings Lite, especially given its browser-based execution environment. This section outlines best practices for managing sensitive information and securing your API interactions.

### 10.1 Environment Variables for Secrets
xlwings Lite runs in a secure browser sandbox and cannot directly access local system environment variables. It provides two ways to set environment variables:

-   **Add-in Scope (Recommended for Secrets)**:
    -   Stored in the browser's local storage.
    -   Available across all workbooks.
    -   Never leaves your machine.
    -   **Use for API keys and sensitive secrets.**
    -   *Note*: These are cleared when the Office cache is cleared, so make backups!

-   **Workbook Scope**:
    -   Stored directly within the current workbook.
    -   **Not recommended for secrets** as they are embedded in the file.
    -   Specific to each workbook.

**Setting Environment Variables**:
1.  In the xlwings Lite add-in, navigate to the Environment Variables settings.
2.  Provide the Name (e.g., `OPENAI_API_KEY`), Value (e.g., `your-key`), and select the desired Scope (Add-in or Workbook).
3.  Click Save.
4.  Restart xlwings Lite for changes to take effect.

**Using Environment Variables in Code**:
```python
import os
import xlwings as xw
from xlwings import func, script

@script
def sample_script(book: xw.Book):
    key = os.getenv("OPENAI_API_KEY")
    if key is not None:
        print(key)
    else:
        raise Exception("Store your OPENAI_API_KEY key under Environment Variables!")
```

**Important Notes**:
-   Add-in scope overrides Workbook scope variables if names conflict.
-   Always back up important add-in scope variables.
-   Restart xlwings Lite after setting new variables to ensure they are loaded.

### 10.2 Cross-Origin Resource Sharing (CORS)
Since xlwings Lite runs in the browser, all HTTP requests are subject to CORS policies.

**Key Points:**
- Requests originate from `https://addin.xlwings.org` (include this in your server's `Access-Control-Allow-Origin`)
- Requests go directly from user's browser to your API server (not through xlwings.org)
- For IP whitelisting, whitelist the **client's IP**, not xlwings.org servers
- Include `Authorization` header in `pyfetch` for token-based auth

## 11. Python Dependencies Management
Packages are managed via `requirements.txt` tab in the editor. Packages must be Pyodide-compatible ([check list](https://pyodide.org/en/stable/usage/packages-in-pyodide.html)).

**Version Pinning Rules (IMPORTANT):**
```python
# Pure Python packages - PIN versions
xlwings==0.33.14
requests==2.31.0

# Pyodide-provided packages - DON'T PIN (use Pyodide's version)
pandas
numpy
```

**Notes:** Restart xlwings Lite after changing packages. Private packages can use direct wheel URLs.


## 12. Latest Features (as of June 2025)
Recent updates have added several important capabilities:

1. **Self-Hosting Support** (June 2025):
   - Build custom Docker images
   - Include additional packages
   - Self-host the add-in

2. **Sheet Button Support** (May 2025):
   - Create clickable buttons on sheets
   - Configure with `button` parameter
   - Requires xlwings 0.33.14+

3. **Performance Optimizations** (May 2025):
   - `include`/`exclude` configuration for scripts
   - Control workbook data transfer
   - Optimize for large workbooks

4. **Font Formatting** (April 2025):
   - Can now set font properties:
     - bold, italic, color
     - size, name
   - Note: Cannot read font properties

5. **Polars Support** (April 2025):
   - Native converter for Polars DataFrame
   - Native converter for Polars Series

6. **Bug Fixes and Improvements**:
   - Better error tracebacks in output pane
   - Fixed `Range.expand()`
  
## 13. Example Scripts (Quick Reference Patterns)

> **Note:** These examples focus on xlwings Lite-specific patterns only. For full working scripts, refer to your separate reference files.

### 13.1 Core Script Pattern
```python
@script
def my_script(book: xw.Book):
    # 1. Get data from table (ALWAYS use find_table_in_workbook helper)
    sheet, table = find_table_in_workbook(book, 'MyTable')
    df = table.range.options(pd.DataFrame, index=False).value

    # 2. Process data (pure Python/pandas)
    result_df = df.groupby('Category').agg({'Value': 'sum'}).reset_index()

    # 3. Write results - delete existing sheet first for re-runnability
    for s in book.sheets:
        if s.name == 'Results': s.delete()

    new_sheet = book.sheets.add(name='Results')
    new_sheet["A1"].options(index=False).value = result_df

    # 4. Create table with EXPLICIT range sizing (NEVER use .expand() on new data)
    table_range = new_sheet["A1"].resize(result_df.shape[0] + 1, result_df.shape[1])
    try:
        new_sheet.tables.add(source=table_range)
    except Exception as e:
        print(f"Table creation failed: {e}")

    new_sheet.activate()
```

### 13.2 Formatting (Hex Colors Only)
```python
header_range.color = '#4472C4'        # CORRECT: hex string
header_range.font.color = '#FFFFFF'
header_range.font.bold = True
# WRONG: header_range.color = (68, 114, 196)  # RGB tuples raise ValueError
```

### 13.3 Async API Pattern (pyfetch for External Data)
```python
from pyodide.http import pyfetch

@script
async def fetch_external_data(book: xw.Book):
    response = await pyfetch(
        "https://api.example.com/data",
        method="GET",
        headers={"Accept": "application/json"}
    )
    if response.ok:
        data = await response.json()
        # Process and write to Excel...
    else:
        print(f"API Error: {response.status}")
```

### 13.4 Writing Non-DataFrame Data (Cell-by-Cell)
```python
# WRONG: 2D list writes are unstable in Lite
# sheet["A1"].value = [["Label", value], ["Label2", value2]]

# CORRECT: Write atomically, one cell at a time
sheet["A1"].value = "Chi-Square:"
sheet["B1"].value = chi2_value
sheet["A2"].value = "P-Value:"
sheet["B2"].value = p_value
```

### 13.5 Mixed Data Type Prevention
```python
# WRONG: Mixed types cause InvalidArgument
report_rows = [
    {'Metric': 'Score', 'Value': '< 600'},
    {'Metric': 'Score', 'Value': 600},      # Number mixed with string!
]

# CORRECT: Convert entire column to string before writing
df = pd.DataFrame(report_rows)
df['Value'] = df['Value'].astype(str)
sheet["A1"].options(index=False).value = df
```

<!-- END OF SECTION 13 - Full example scripts removed. Refer to separate reference files for complete implementations. -->
